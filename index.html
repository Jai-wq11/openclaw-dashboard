<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OpenClaw Business Dashboard</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Inter', 'Segoe UI', sans-serif; background: #1a1a2e; color: #e0e0e0; overflow-x: hidden; }
        .container { display: flex; min-height: 100vh; }

        .sidebar { width: 250px; background: #16213e; padding: 2rem 1rem; border-right: 1px solid #0f3460; position: sticky; top: 0; height: 100vh; overflow-y: auto; }
        .logo { font-size: 1.5rem; font-weight: 700; margin-bottom: 2rem; color: #e94560; }
        .nav-item { padding: 0.75rem 1rem; margin: 0.5rem 0; border-radius: 8px; cursor: pointer; transition: all 0.2s; display: flex; align-items: center; gap: 0.75rem; }
        .nav-item:hover { background: #0f3460; }
        .nav-item.active { background: #0f3460; color: #e94560; }
        .sidebar-divider { border-top: 1px solid #0f3460; margin: 1.5rem 0; }

        .main-content { flex: 1; padding: 2rem; max-width: 1400px; }
        .view { display: none; }
        .view.active { display: block; animation: fadeIn 0.3s; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        h1 { margin-bottom: 2rem; font-size: 2rem; }

        .stat-card { background: #16213e; padding: 1.5rem; border-radius: 12px; border: 1px solid #0f3460; }
        .stat-label { color: #888; font-size: 0.875rem; margin-bottom: 0.5rem; }
        .stat-value { font-size: 2rem; font-weight: 700; color: #e94560; }

        .table-controls { display: flex; justify-content: space-between; margin-bottom: 1.5rem; gap: 1rem; flex-wrap: wrap; }
        .search-bar { flex: 1; max-width: 400px; padding: 0.75rem; background: #16213e; border: 1px solid #0f3460; border-radius: 8px; color: #e0e0e0; font-size: 1rem; }
        .btn { padding: 0.75rem 1.5rem; border: none; border-radius: 8px; cursor: pointer; font-size: 1rem; transition: all 0.2s; font-weight: 500; }
        .btn-primary { background: #e94560; color: white; }
        .btn-primary:hover { background: #d63851; }
        .btn-secondary { background: #0f3460; color: #e0e0e0; }
        .btn-secondary:hover { background: #1a4d7a; }
        .btn-danger { background: #c92a3e; color: white; }
        .btn-sm { padding: 0.5rem 1rem; font-size: 0.875rem; }
        .status-badge { padding: 0.2rem 0.6rem; border-radius: 12px; font-size: 0.75rem; font-weight: 600; text-transform: uppercase; }

        table { width: 100%; border-collapse: collapse; background: #16213e; border-radius: 12px; overflow: hidden; }
        th { background: #0f3460; padding: 1rem; text-align: left; font-weight: 600; cursor: pointer; user-select: none; }
        th:hover { background: #1a4d7a; }
        td { padding: 1rem; border-top: 1px solid #0f3460; }
        tr:hover { background: #1a2844; }

        input[type="text"], input[type="number"], input[type="date"], input[type="datetime-local"], input[type="url"], select, textarea {
            width: 100%; padding: 0.5rem; background: #1a1a2e; border: 1px solid #0f3460; border-radius: 6px; color: #e0e0e0; font-size: 0.875rem;
        }
        input[type="checkbox"] { width: 20px; height: 20px; cursor: pointer; }
        textarea { min-height: 60px; resize: vertical; }

        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 1000; align-items: center; justify-content: center; }
        .modal.active { display: flex; animation: fadeIn 0.2s; }
        .modal-content { background: #16213e; padding: 2rem; border-radius: 12px; max-width: 600px; width: 90%; max-height: 90vh; overflow-y: auto; border: 1px solid #0f3460; }
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem; }
        .modal-header h2 { font-size: 1.5rem; }
        .close-btn, .close-modal { background: none; border: none; font-size: 1.5rem; color: #888; cursor: pointer; padding: 0; }
        .close-btn:hover, .close-modal:hover { color: #e94560; }
        .form-group { margin-bottom: 1.5rem; }
        .form-group label { display: block; margin-bottom: 0.5rem; color: #888; font-size: 0.875rem; }
        .form-actions { display: flex; gap: 1rem; justify-content: flex-end; margin-top: 2rem; }

        .toast { position: fixed; bottom: 2rem; right: 2rem; background: #16213e; padding: 1rem 1.5rem; border-radius: 8px; border: 1px solid #0f3460; z-index: 2000; animation: slideIn 0.3s; box-shadow: 0 4px 12px rgba(0,0,0,0.3); }
        @keyframes slideIn { from { transform: translateX(400px); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
        .toast.success { border-left: 4px solid #4caf50; }
        .toast.error { border-left: 4px solid #e94560; }

        .calendar-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem; }
        .calendar-nav { display: flex; gap: 1rem; align-items: center; }
        .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 1px; background: #0f3460; border: 1px solid #0f3460; border-radius: 12px; overflow: hidden; }
        .calendar-day-header { background: #0f3460; padding: 1rem; text-align: center; font-weight: 600; }
        .calendar-day { background: #16213e; padding: 0.75rem; min-height: 100px; cursor: pointer; transition: background 0.2s; }
        .calendar-day:hover { background: #1a2844; }
        .calendar-day.other-month { opacity: 0.3; }
        .calendar-day-number { font-weight: 600; margin-bottom: 0.5rem; }
        .calendar-event { font-size: 0.75rem; padding: 0.25rem 0.5rem; border-radius: 4px; margin: 0.25rem 0; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
        .calendar-event.customer { background: #2196f3; }
        .calendar-event.todo { background: #ff9800; }
        .legend { display: flex; gap: 2rem; margin-bottom: 2rem; }
        .legend-item { display: flex; align-items: center; gap: 0.5rem; }
        .legend-color { width: 20px; height: 20px; border-radius: 4px; }

        input[type="file"] { display: none; }

        .folder-card { background: #16213e; border: 1px solid #0f3460; border-radius: 12px; padding: 1.5rem; cursor: pointer; transition: all 0.2s; text-align: center; }
        .folder-card:hover { background: #1a2844; border-color: #e94560; transform: translateY(-2px); }
        .folder-icon { font-size: 2.5rem; margin-bottom: 0.5rem; }
        .folder-name { font-weight: 600; font-size: 1rem; }
        .folder-meta { color: #888; font-size: 0.8rem; margin-top: 0.25rem; }
        .note-card { background: #1a2844; border: 1px solid #0f3460; border-radius: 8px; padding: 1rem; }
        .note-card .note-time { color: #888; font-size: 0.75rem; margin-bottom: 0.5rem; }
        .note-card .note-text { font-size: 0.9rem; white-space: pre-wrap; }
        .drag-card { background: #16213e; border: 1px solid #0f3460; border-radius: 8px; padding: 0.75rem 1rem; cursor: grab; transition: all 0.2s; }
        .drag-card:hover { background: #1a2844; border-color: #e94560; }
        .drag-card:active { cursor: grabbing; }
        .drop-zone { min-height: 80px; border: 2px dashed #0f3460; border-radius: 8px; padding: 0.75rem; transition: all 0.2s; }
        .drop-zone.drag-over { border-color: #e94560; background: rgba(233,69,96,0.1); }
        .employee-section { background: #16213e; border: 1px solid #0f3460; border-radius: 12px; padding: 1rem; }
        .employee-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.75rem; }
        .employee-remove { color: #888; font-size: 0.8rem; cursor: pointer; }
        .employee-remove:hover { color: #e94560; }
        .assigned-card { background: #1a2844; border: 1px solid #0f3460; border-radius: 8px; padding: 0.75rem; margin-bottom: 0.5rem; display: flex; justify-content: space-between; align-items: flex-start; }
        .remove-btn { cursor: pointer; font-size: 0.9rem; }
        @media (max-width: 768px) {
            .sidebar { width: 80px; padding: 1rem 0.5rem; }
            .nav-item span:not(.nav-icon) { display: none; }
            .logo { font-size: 1rem; }
            .main-content { padding: 1rem; }
            .table-controls { flex-direction: column; }
            .search-bar { max-width: 100%; }
            table { font-size: 0.875rem; }
            th, td { padding: 0.5rem; }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="sidebar">
            <div class="logo">ü¶Ö OpenClaw</div>
            <div class="nav-item active" data-view="customers">
                <span class="nav-icon">üë•</span>
                <span>Customers</span>
            </div>
            <div class="nav-item" data-view="calendar">
                <span class="nav-icon">üìÖ</span>
                <span>Calendar</span>
            </div>
            <div class="nav-item" data-view="todos">
                <span class="nav-icon">‚úÖ</span>
                <span>To-Do List</span>
            </div>
            <div class="nav-item" data-view="assignments">
                <span class="nav-icon">üîó</span>
                <span>Assignments</span>
            </div>
            <div class="nav-item" data-view="folders">
                <span class="nav-icon">üìÅ</span>
                <span>Client Folders</span>
            </div>
            <div class="sidebar-divider"></div>
            <div class="nav-item" onclick="exportAllData()">
                <span class="nav-icon">üì§</span>
                <span>Export Data</span>
            </div>
            <div class="nav-item" onclick="document.getElementById('import-file-input').click()">
                <span class="nav-icon">üì•</span>
                <span>Import Data</span>
            </div>
        </div>

        <div class="main-content">
            <!-- Customers View -->
            <div class="view active" id="customers">
                <h1>Customers</h1>
                <div class="table-controls">
                    <input type="text" class="search-bar" id="customer-search" placeholder="Search customers...">
                    <div style="display: flex; gap: 1rem;">
                        <button class="btn btn-secondary btn-sm" onclick="exportCustomersCSV()">üì• Export CSV</button>
                        <button class="btn btn-primary" onclick="showAddCustomer()">+ Add Customer</button>
                    </div>
                </div>
                <div style="overflow-x: auto;">
                    <table>
                        <thead>
                            <tr>
                                <th onclick="sortTable('customers', 'name')">Name</th>
                                <th onclick="sortTable('customers', 'callDate')">Time</th>
                                <th>Notes</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="customers-tbody"></tbody>
                    </table>
                </div>
            </div>

            <!-- Calendar View -->
            <div class="view" id="calendar">
                <h1>Calendar</h1>
                <p style="color:#e94560;font-size:0.9rem;margin-bottom:10px;">‚è∞ All times shown in Hong Kong Time (HKT / GMT+8)</p>
                <div class="legend">
                    <div class="legend-item">
                        <div class="legend-color" style="background: #2196f3;"></div>
                        <span>Customers</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color" style="background: #ff9800;"></div>
                        <span>To-Do Due Dates</span>
                    </div>
                </div>
                <div class="calendar-header">
                    <h2 id="calendar-month-year"></h2>
                    <div class="calendar-nav">
                        <button class="btn btn-secondary btn-sm" onclick="changeMonth(-1)">‚Üê Prev</button>
                        <button class="btn btn-secondary btn-sm" onclick="goToToday()">Today</button>
                        <button class="btn btn-secondary btn-sm" onclick="changeMonth(1)">Next ‚Üí</button>
                    </div>
                </div>
                <div class="calendar-grid" id="calendar-grid"></div>
            </div>

            <!-- To-Do List View -->
            <div class="view" id="todos">
                <h1>To-Do List</h1>
                <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px;">
                    <div style="display:flex;gap:10px;">
                        <select id="todo-filter-urgency" onchange="renderTodos()" style="padding:8px;border-radius:6px;background:#16213e;color:white;border:1px solid #0f3460;">
                            <option value="">All Urgency</option>
                            <option value="üî¥ Critical">üî¥ Critical</option>
                            <option value="üü° High">üü° High</option>
                            <option value="üîµ Medium">üîµ Medium</option>
                            <option value="‚ö™ Low">‚ö™ Low</option>
                        </select>
                        <select id="todo-filter-assignee" onchange="renderTodos()" style="padding:8px;border-radius:6px;background:#16213e;color:white;border:1px solid #0f3460;">
                            <option value="">All Assignees</option>
                        </select>
                    </div>
                    <button class="btn btn-primary" onclick="showAddTodo()">+ Add Task</button>
                </div>
                <table>
                    <thead>
                        <tr>
                            <th>Done</th>
                            <th onclick="sortTable('todos', 'urgency')">Urgency</th>
                            <th onclick="sortTable('todos', 'task')">Task</th>
                            <th onclick="sortTable('todos', 'assignee')">Assigned To</th>
                            <th onclick="sortTable('todos', 'dueDate')">Due Date</th>
                            <th onclick="sortTable('todos', 'status')">Status</th>
                            <th>Notes</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="todos-tbody"></tbody>
                </table>
            </div>

            <!-- Assignments View -->
            <div class="view" id="assignments">
                <h1>üîó Assignments</h1>
                <div style="display:flex;gap:1rem;margin-bottom:1.5rem;align-items:center;">
                    <button class="btn btn-primary btn-sm" onclick="addAssignmentEmployee()">+ Add Employee</button>
                    <span style="color:#888;font-size:0.875rem;">Drag a customer onto an employee to assign them</span>
                </div>
                <div style="display:grid;grid-template-columns:1fr 2fr;gap:2rem;min-height:400px;">
                    <!-- Unassigned Customers -->
                    <div>
                        <h2 style="font-size:1.2rem;margin-bottom:1rem;color:#e94560;">üìã Unassigned Customers</h2>
                        <div id="unassigned-customers" style="display:flex;flex-direction:column;gap:0.5rem;"></div>
                    </div>
                    <!-- Employee Drop Zones -->
                    <div>
                        <h2 style="font-size:1.2rem;margin-bottom:1rem;color:#e94560;">üë• Employees</h2>
                        <div id="employees-drop-zones" style="display:flex;flex-direction:column;gap:1.5rem;"></div>
                    </div>
                </div>
            </div>

            <!-- Client Folders View -->
            <div class="view" id="folders">
                <h1>üìÅ Client Folders</h1>
                <p style="color:#888;margin-bottom:1.5rem;">Each customer gets a folder. Click to open and add internal notes.</p>
                <div id="folders-grid" style="display:grid;grid-template-columns:repeat(auto-fill,minmax(220px,1fr));gap:1rem;"></div>
            </div>

            <!-- Folder Detail (shown when a folder is opened) -->
            <div class="view" id="folder-detail">
                <div style="display:flex;align-items:center;gap:1rem;margin-bottom:1.5rem;">
                    <button class="btn btn-secondary btn-sm" onclick="closeFolderDetail()">‚Üê Back</button>
                    <h1 id="folder-detail-name" style="margin-bottom:0;"></h1>
                </div>
                <div style="display:grid;grid-template-columns:1fr 1fr;gap:1.5rem;margin-bottom:1.5rem;">
                    <div class="stat-card"><div class="stat-label">Call Time</div><div id="folder-detail-time" style="font-size:1.1rem;"></div></div>
                    <div class="stat-card"><div class="stat-label">Customer Notes</div><div id="folder-detail-customer-notes" style="font-size:0.9rem;color:#aaa;"></div></div>
                </div>
                <h2 style="font-size:1.2rem;margin-bottom:1rem;">üìù Internal Notes</h2>
                <div style="display:flex;gap:1rem;margin-bottom:1rem;">
                    <textarea id="folder-new-note" rows="3" placeholder="Add an internal note..." style="flex:1;"></textarea>
                    <button class="btn btn-primary" onclick="addFolderNote()" style="align-self:flex-end;">Add Note</button>
                </div>
                <div id="folder-notes-list" style="display:flex;flex-direction:column;gap:0.75rem;"></div>
            </div>
        </div>
    </div>

    <!-- Customer Modal -->
    <div class="modal" id="customer-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="customer-modal-title">Add Customer</h2>
                <button class="close-btn" onclick="closeModal('customer-modal')">√ó</button>
            </div>
            <form id="customer-form">
                <input type="hidden" id="customer-id">
                <div class="form-group">
                    <label>Name *</label>
                    <input type="text" id="customer-name" required>
                </div>
                <div class="form-group">
                    <label>Time (Call Date/Time)</label>
                    <input type="datetime-local" id="customer-calldate">
                </div>
                <div class="form-group">
                    <label>Notes</label>
                    <textarea id="customer-notes" rows="4"></textarea>
                </div>
                <div class="form-actions">
                    <button type="button" class="btn btn-secondary" onclick="closeModal('customer-modal')">Cancel</button>
                    <button type="submit" class="btn btn-primary">Save</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Todo Modal -->
    <div class="modal" id="todo-modal">
        <div class="modal-content" style="max-width:500px">
            <div class="modal-header">
                <h2 id="todo-modal-title">Add Task</h2>
                <span class="close-modal" onclick="closeModal('todo-modal')">&times;</span>
            </div>
            <form id="todo-form" onsubmit="saveTodo(event)">
                <input type="hidden" id="todo-id">
                <div class="form-group">
                    <label>Task</label>
                    <input type="text" id="todo-task" required placeholder="What needs to be done?">
                </div>
                <div class="form-group">
                    <label>Urgency</label>
                    <select id="todo-urgency">
                        <option value="üî¥ Critical">üî¥ Critical</option>
                        <option value="üü° High">üü° High</option>
                        <option value="üîµ Medium">üîµ Medium</option>
                        <option value="‚ö™ Low">‚ö™ Low</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Assigned To</label>
                    <select id="todo-assignee">
                        <option value="Ty">Ty</option>
                        <option value="Jaiden">Jaiden</option>
                        <option value="Unassigned">Unassigned</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Due Date</label>
                    <input type="date" id="todo-due-date">
                </div>
                <div class="form-group">
                    <label>Status</label>
                    <select id="todo-status">
                        <option value="To Do">To Do</option>
                        <option value="In Progress">In Progress</option>
                        <option value="Blocked">Blocked</option>
                        <option value="Done">Done</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Notes</label>
                    <textarea id="todo-notes" rows="2"></textarea>
                </div>
                <button type="submit" class="btn btn-primary" style="width:100%">Save Task</button>
            </form>
        </div>
    </div>

    <!-- Assignment Modal -->
    <div class="modal" id="assignment-modal">
        <div class="modal-content" style="max-width:500px">
            <div class="modal-header">
                <h2>Assign Customer</h2>
                <button class="close-btn" onclick="closeModal('assignment-modal')">√ó</button>
            </div>
            <form id="assignment-form">
                <input type="hidden" id="assign-customer-id">
                <input type="hidden" id="assign-employee-name">
                <div class="form-group"><label>Customer</label><input type="text" id="assign-customer-name" readonly></div>
                <div class="form-group"><label>Employee</label><input type="text" id="assign-employee-display" readonly></div>
                <div class="form-group"><label>Call Time</label><input type="datetime-local" id="assign-call-time"></div>
                <div class="form-group"><label>Goals for this call</label><textarea id="assign-goals" rows="4" placeholder="What should be accomplished during this call?"></textarea></div>
                <div class="form-actions">
                    <button type="button" class="btn btn-secondary" onclick="closeModal('assignment-modal')">Cancel</button>
                    <button type="submit" class="btn btn-primary">Assign</button>
                </div>
            </form>
        </div>
    </div>

    <footer style="position:fixed;bottom:0;right:0;padding:6px 14px;font-size:0.7rem;color:#555;background:#16213e;border-top:1px solid #0f3460;border-left:1px solid #0f3460;border-radius:8px 0 0 0;">
        Last updated: Feb 28, 2026
    </footer>

    <input type="file" id="import-file-input" accept=".json" onchange="importAllData(event)">

    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
    <script>
        const firebaseConfig = { databaseURL: "https://openclaw-dashboard-28911-default-rtdb.asia-southeast1.firebasedatabase.app" };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();
        const dbRef = db.ref('dashboard');
        let firebaseReady = false;
        let suppressFirebaseWrite = false;

        let customers = [];
        let todos = [];
        let assignments = [];
        let assignmentEmployees = [];
        let currentCalendarDate = new Date();

        function init() {
            loadData();
            loadFolderNotes();
            renderCustomers();
            renderTodos();
            renderCalendar();
            renderAssignments();
            renderFolders();
            setupNavigation();
            setupForms();
        }

        function loadData() {
            const sc = localStorage.getItem('customers');
            if (sc) {
                customers = JSON.parse(sc).map(c => ({ id: c.id, name: c.name || '', callDate: c.callDate || '', notes: c.notes || '' }));
            }
            const st = localStorage.getItem('todos');
            if (st) todos = JSON.parse(st);
            const sa = localStorage.getItem('assignments');
            if (sa) assignments = JSON.parse(sa);
            const sae = localStorage.getItem('assignmentEmployees');
            assignmentEmployees = sae ? JSON.parse(sae) : ['Ty', 'Jaiden'];
            updateAssigneeFilter();
        }

        function saveCustomers() { localStorage.setItem('customers', JSON.stringify(customers)); syncToCloud(); }
        function saveTodos() { localStorage.setItem('todos', JSON.stringify(todos)); syncToCloud(); }
        function saveAssignments() { localStorage.setItem('assignments', JSON.stringify(assignments)); localStorage.setItem('assignmentEmployees', JSON.stringify(assignmentEmployees)); syncToCloud(); }

        // Firebase
        function getAllData() {
            return { customers, todos, assignments, assignmentEmployees, folderNotes, updatedAt: Date.now() };
        }
        function applyData(data) {
            if (data.customers) { customers = data.customers; localStorage.setItem('customers', JSON.stringify(customers)); }
            if (data.todos) { todos = data.todos; localStorage.setItem('todos', JSON.stringify(todos)); }
            if (data.assignments) { assignments = data.assignments; localStorage.setItem('assignments', JSON.stringify(assignments)); }
            if (data.assignmentEmployees) { assignmentEmployees = data.assignmentEmployees; localStorage.setItem('assignmentEmployees', JSON.stringify(assignmentEmployees)); }
            if (data.folderNotes) { folderNotes = data.folderNotes; localStorage.setItem('folderNotes', JSON.stringify(folderNotes)); }
        }
        function syncToCloud() {
            if (!firebaseReady || suppressFirebaseWrite) return;
            dbRef.set(getAllData()).catch(err => console.error('Firebase write error:', err));
        }
        dbRef.on('value', (snapshot) => {
            const data = snapshot.val();
            if (!data || !data.updatedAt) { firebaseReady = true; syncToCloud(); return; }
            firebaseReady = true;
            suppressFirebaseWrite = true;
            applyData(data);
            renderCustomers(); renderTodos(); renderCalendar(); renderAssignments(); renderFolders();
            suppressFirebaseWrite = false;
        });

        // Navigation
        function setupNavigation() {
            document.querySelectorAll('.nav-item').forEach(item => {
                if (item.dataset.view) {
                    item.addEventListener('click', () => {
                        document.querySelectorAll('.nav-item').forEach(i => i.classList.remove('active'));
                        item.classList.add('active');
                        document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
                        document.getElementById(item.dataset.view).classList.add('active');
                        if (item.dataset.view === 'calendar') renderCalendar();
                        if (item.dataset.view === 'assignments') renderAssignments();
                        if (item.dataset.view === 'folders') renderFolders();
                    });
                }
            });
        }

        // === CUSTOMERS ===
        function renderCustomers() {
            const search = document.getElementById('customer-search').value.toLowerCase();
            const filtered = customers.filter(c => c.name.toLowerCase().includes(search) || (c.notes||'').toLowerCase().includes(search));
            document.getElementById('customers-tbody').innerHTML = filtered.map(c => `
                <tr>
                    <td>${c.name}</td>
                    <td>${c.callDate ? new Date(c.callDate).toLocaleString() : 'TBD'}</td>
                    <td style="max-width:400px;overflow:hidden;text-overflow:ellipsis;">${c.notes||''}</td>
                    <td style="white-space:nowrap;">
                        <button class="btn btn-secondary btn-sm" onclick="editCustomer(${c.id})">‚úèÔ∏è</button>
                        <button class="btn btn-danger btn-sm" onclick="deleteCustomer(${c.id})">üóëÔ∏è</button>
                    </td>
                </tr>`).join('');
        }
        function showAddCustomer() {
            document.getElementById('customer-modal-title').textContent = 'Add Customer';
            document.getElementById('customer-form').reset();
            document.getElementById('customer-id').value = '';
            openModal('customer-modal');
        }
        function editCustomer(id) {
            const c = customers.find(x => x.id === id); if (!c) return;
            document.getElementById('customer-modal-title').textContent = 'Edit Customer';
            document.getElementById('customer-id').value = c.id;
            document.getElementById('customer-name').value = c.name;
            document.getElementById('customer-calldate').value = c.callDate || '';
            document.getElementById('customer-notes').value = c.notes || '';
            openModal('customer-modal');
        }
        function deleteCustomer(id) {
            if (!confirm('Delete this customer?')) return;
            customers = customers.filter(c => c.id !== id);
            saveCustomers(); renderCustomers(); renderCalendar();
            showToast('Customer deleted', 'success');
        }
        function exportCustomersCSV() {
            const csv = ['Name,Time,Notes', ...customers.map(c => `"${(c.name||'').replace(/"/g,'""')}","${c.callDate||''}","${(c.notes||'').replace(/"/g,'""')}"`)] .join('\n');
            downloadBlob(csv, 'customers.csv', 'text/csv');
            showToast('Exported CSV', 'success');
        }

        // === TODOS ===
        function renderTodos() {
            const fu = document.getElementById('todo-filter-urgency').value;
            const fa = document.getElementById('todo-filter-assignee').value;
            let filtered = todos;
            if (fu) filtered = filtered.filter(t => t.urgency === fu);
            if (fa) filtered = filtered.filter(t => t.assignee === fa);
            const uo = {'üî¥ Critical':0,'üü° High':1,'üîµ Medium':2,'‚ö™ Low':3};
            filtered.sort((a,b) => { if (a.done !== b.done) return a.done?1:-1; return (uo[a.urgency]||4)-(uo[b.urgency]||4); });
            document.getElementById('todos-tbody').innerHTML = filtered.map(t => `
                <tr style="${t.done?'opacity:0.5;text-decoration:line-through;':''}">
                    <td><input type="checkbox" ${t.done?'checked':''} onchange="toggleTodoDone(${t.id})"></td>
                    <td>${t.urgency}</td>
                    <td>${t.task}</td>
                    <td>${t.assignee}</td>
                    <td>${t.dueDate||'-'}</td>
                    <td><span style="padding:0.25rem 0.75rem;border-radius:4px;background:${t.status==='Done'?'#1a472a':t.status==='In Progress'?'#0f3460':t.status==='Blocked'?'#5c1a1a':'#2a2a3e'};font-size:0.875rem;">${t.status}</span></td>
                    <td style="max-width:200px;overflow:hidden;text-overflow:ellipsis;">${t.notes||'-'}</td>
                    <td style="white-space:nowrap;">
                        <button class="btn btn-secondary btn-sm" onclick="editTodo(${t.id})">‚úèÔ∏è</button>
                        <button class="btn btn-danger btn-sm" onclick="deleteTodo(${t.id})">üóëÔ∏è</button>
                    </td>
                </tr>`).join('');
        }
        function showAddTodo() {
            document.getElementById('todo-modal-title').textContent = 'Add Task';
            document.getElementById('todo-form').reset();
            document.getElementById('todo-id').value = '';
            openModal('todo-modal');
        }
        function editTodo(id) {
            const t = todos.find(x => x.id === id); if (!t) return;
            document.getElementById('todo-modal-title').textContent = 'Edit Task';
            document.getElementById('todo-id').value = t.id;
            document.getElementById('todo-task').value = t.task;
            document.getElementById('todo-urgency').value = t.urgency;
            document.getElementById('todo-assignee').value = t.assignee;
            document.getElementById('todo-due-date').value = t.dueDate;
            document.getElementById('todo-status').value = t.status;
            document.getElementById('todo-notes').value = t.notes;
            openModal('todo-modal');
        }
        function saveTodo(e) {
            e.preventDefault();
            const id = document.getElementById('todo-id').value;
            const todo = {
                id: id ? parseInt(id) : Date.now(),
                task: document.getElementById('todo-task').value,
                urgency: document.getElementById('todo-urgency').value,
                assignee: document.getElementById('todo-assignee').value,
                dueDate: document.getElementById('todo-due-date').value,
                status: document.getElementById('todo-status').value,
                notes: document.getElementById('todo-notes').value,
                done: id ? (todos.find(t=>t.id===parseInt(id))?.done||false) : false
            };
            if (id) { const idx = todos.findIndex(t=>t.id===parseInt(id)); todos[idx]=todo; }
            else todos.push(todo);
            saveTodos(); renderTodos(); renderCalendar(); closeModal('todo-modal');
            showToast(id?'Task updated!':'Task added!');
        }
        function deleteTodo(id) {
            if (!confirm('Delete this task?')) return;
            todos = todos.filter(t=>t.id!==id);
            saveTodos(); renderTodos(); renderCalendar();
            showToast('Task deleted');
        }
        function toggleTodoDone(id) {
            const t = todos.find(x=>x.id===id);
            if (t) { t.done=!t.done; if(t.done) t.status='Done'; saveTodos(); renderTodos(); }
        }
        function updateAssigneeFilter() {
            const names = [...new Set(todos.map(t=>t.assignee).filter(Boolean))];
            const sel = document.getElementById('todo-filter-assignee');
            sel.innerHTML = '<option value="">All Assignees</option>' + names.map(n=>`<option value="${n}">${n}</option>`).join('');
        }

        // === CALENDAR ===
        function renderCalendar() {
            const year = currentCalendarDate.getFullYear(), month = currentCalendarDate.getMonth();
            document.getElementById('calendar-month-year').textContent = currentCalendarDate.toLocaleDateString('en-US',{month:'long',year:'numeric'});
            const startDay = new Date(year,month,1).getDay();
            const daysInMonth = new Date(year,month+1,0).getDate();
            const grid = document.getElementById('calendar-grid');
            grid.innerHTML = '';
            ['Sun','Mon','Tue','Wed','Thu','Fri','Sat'].forEach(d => {
                const h = document.createElement('div'); h.className='calendar-day-header'; h.textContent=d; grid.appendChild(h);
            });
            const prevDays = new Date(year,month,0).getDate();
            for (let i=startDay-1;i>=0;i--) { const d=document.createElement('div'); d.className='calendar-day other-month'; d.innerHTML=`<div class="calendar-day-number">${prevDays-i}</div>`; grid.appendChild(d); }
            for (let i=1;i<=daysInMonth;i++) {
                const d=document.createElement('div'); d.className='calendar-day';
                const date=new Date(year,month,i); const events=getEventsForDate(date);
                d.innerHTML=`<div class="calendar-day-number">${i}</div>${events.map(e=>`<div class="calendar-event ${e.type}">${e.text}</div>`).join('')}`;
                if(events.length){d.style.cursor='pointer';d.onclick=()=>showDayDetail(date,events);}
                grid.appendChild(d);
            }
            const rem=42-(startDay+daysInMonth);
            for(let i=1;i<=rem;i++){const d=document.createElement('div');d.className='calendar-day other-month';d.innerHTML=`<div class="calendar-day-number">${i}</div>`;grid.appendChild(d);}
        }
        function getEventsForDate(date) {
            const events=[];
            const ds=date.getFullYear()+'-'+String(date.getMonth()+1).padStart(2,'0')+'-'+String(date.getDate()).padStart(2,'0');
            customers.forEach(c=>{if(c.callDate){const cd=new Date(c.callDate);const cds=cd.getFullYear()+'-'+String(cd.getMonth()+1).padStart(2,'0')+'-'+String(cd.getDate()).padStart(2,'0');if(cds===ds){events.push({type:'customer',text:`${cd.toLocaleTimeString('en-US',{hour:'numeric',minute:'2-digit'})} - ${c.name}`});}}});
            todos.forEach(t=>{if(t.dueDate===ds&&!t.done){events.push({type:'todo',text:`üìã ${t.task}`});}});
            return events;
        }
        function showDayDetail(date,events) {
            const dateStr=date.toLocaleDateString('en-US',{weekday:'long',month:'long',day:'numeric',year:'numeric'});
            const html=events.map(e=>`<div style="padding:10px;margin:8px 0;border-radius:8px;background:${e.type==='customer'?'#0f3460':'#4a3000'};border-left:4px solid ${e.type==='customer'?'#4a90d9':'#ff9800'};"><strong>${e.text}</strong><div style="font-size:0.85rem;color:#aaa;margin-top:4px;">${e.type==='customer'?'Customer':'To-Do'}</div></div>`).join('');
            let modal=document.getElementById('day-detail-modal');
            if(!modal){modal=document.createElement('div');modal.id='day-detail-modal';modal.className='modal';modal.innerHTML=`<div class="modal-content" style="max-width:500px"><span class="close-modal" onclick="closeModal('day-detail-modal')">&times;</span><h2 id="day-detail-title"></h2><div id="day-detail-events"></div></div>`;document.body.appendChild(modal);}
            document.getElementById('day-detail-title').textContent='üìÖ '+dateStr;
            document.getElementById('day-detail-events').innerHTML=html;
            openModal('day-detail-modal');
        }
        function changeMonth(d){currentCalendarDate.setMonth(currentCalendarDate.getMonth()+d);renderCalendar();}
        function goToToday(){currentCalendarDate=new Date();renderCalendar();}

        // === FORMS SETUP ===
        function setupForms() {
            document.getElementById('customer-search').addEventListener('input', renderCustomers);
            document.getElementById('customer-form').addEventListener('submit', (e) => {
                e.preventDefault();
                const id=document.getElementById('customer-id').value;
                const c={id:id?parseInt(id):Date.now(),name:document.getElementById('customer-name').value,callDate:document.getElementById('customer-calldate').value,notes:document.getElementById('customer-notes').value};
                if(id){const idx=customers.findIndex(x=>x.id===parseInt(id));customers[idx]=c;}else customers.push(c);
                saveCustomers();renderCustomers();renderCalendar();closeModal('customer-modal');showToast('Customer saved','success');
            });
            document.getElementById('assignment-form').addEventListener('submit', saveAssignment);
        }

        // === SORT ===
        let sortDirection={};
        function sortTable(table,field) {
            const key=`${table}-${field}`; sortDirection[key]=!sortDirection[key];
            const data=table==='customers'?customers:todos;
            data.sort((a,b)=>{let av=a[field]||'',bv=b[field]||'';if(typeof av==='string')av=av.toLowerCase();if(typeof bv==='string')bv=bv.toLowerCase();if(av<bv)return sortDirection[key]?-1:1;if(av>bv)return sortDirection[key]?1:-1;return 0;});
            if(table==='customers')renderCustomers();if(table==='todos')renderTodos();
        }

        // === EXPORT/IMPORT ALL ===
        function exportAllData() {
            const json=JSON.stringify({customers,todos,assignments,assignmentEmployees,folderNotes,exportDate:new Date().toISOString()},null,2);
            downloadBlob(json,`openclaw-dashboard-backup-${new Date().toISOString().split('T')[0]}.json`,'application/json');
            showToast('All data exported','success');
        }
        function importAllData(event) {
            const file=event.target.files[0]; if(!file) return;
            const reader=new FileReader();
            reader.onload=(e)=>{
                try{
                    const data=JSON.parse(e.target.result);
                    if(confirm('This will replace all current data. Continue?')){
                        if(data.customers)customers=data.customers;
                        if(data.todos){todos=data.todos;localStorage.setItem('todos',JSON.stringify(todos));}
                        if(data.assignments){assignments=data.assignments;localStorage.setItem('assignments',JSON.stringify(assignments));}
                        if(data.assignmentEmployees){assignmentEmployees=data.assignmentEmployees;localStorage.setItem('assignmentEmployees',JSON.stringify(assignmentEmployees));}
                        if(data.folderNotes){folderNotes=data.folderNotes;localStorage.setItem('folderNotes',JSON.stringify(folderNotes));}
                        saveCustomers();renderCustomers();renderTodos();renderCalendar();renderAssignments();renderFolders();updateAssigneeFilter();
                        showToast('Data imported','success');
                    }
                }catch(err){showToast('Import error: '+err.message,'error');}
            };
            reader.readAsText(file); event.target.value='';
        }

        // === UTILITIES ===
        function openModal(id){document.getElementById(id).classList.add('active');}
        function closeModal(id){document.getElementById(id).classList.remove('active');}
        function showToast(msg,type='success'){const t=document.createElement('div');t.className=`toast ${type}`;t.textContent=msg;document.body.appendChild(t);setTimeout(()=>t.remove(),3000);}
        function downloadBlob(content,filename,type){const b=new Blob([content],{type});const u=URL.createObjectURL(b);const a=document.createElement('a');a.href=u;a.download=filename;a.click();URL.revokeObjectURL(u);}

        // ===== ASSIGNMENTS =====
        function renderAssignments() {
            const assignedCustomerIds = assignments.map(a => a.customerId);
            const unassigned = customers.filter(c => !assignedCustomerIds.includes(c.id));
            const container = document.getElementById('unassigned-customers');
            if (container) {
                container.innerHTML = unassigned.length === 0 ? '<div style="color:#888;text-align:center;padding:1rem;">All customers assigned</div>' :
                    unassigned.map(c => {
                        const safeName = c.name.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;').replace(/'/g,'&#39;');
                        return `<div class="drag-card" draggable="true" ondragstart="onDragStart(event, ${c.id}, '${safeName}', '${c.callDate||''}')">${safeName}${c.callDate ? ' <span style="color:#888;font-size:0.8rem;">'+new Date(c.callDate).toLocaleString()+'</span>' : ''}</div>`;
                    }).join('');
            }
            const zones = document.getElementById('employees-drop-zones');
            if (zones) {
                zones.innerHTML = assignmentEmployees.map(emp => {
                    const empAssignments = assignments.filter(a => a.employeeName === emp);
                    return `<div class="employee-section">
                        <div class="employee-header"><h4>${emp}</h4><span class="employee-remove" onclick="removeAssignmentEmployee('${emp}')">remove</span></div>
                        <div class="drop-zone" ondragover="onDragOver(event)" ondragleave="onDragLeave(event)" ondrop="onDrop(event, '${emp}')" data-employee="${emp}">
                            ${empAssignments.length === 0 ? '<div style="color:#666;text-align:center;font-size:0.85rem;">Drop customers here</div>' :
                            empAssignments.map(a => `<div class="assigned-card">
                                <div><strong>${a.customerName}</strong><br><span style="color:#888;font-size:0.8rem;">${a.callTime ? new Date(a.callTime).toLocaleString() : 'No time set'}</span>${a.goals ? '<br><span style="font-size:0.8rem;color:#aaa;">'+a.goals+'</span>' : ''}</div>
                                <span class="remove-btn" onclick="removeAssignment(${a.id})">‚ùå</span>
                            </div>`).join('')}
                        </div>
                    </div>`;
                }).join('');
            }
        }

        let dragData = {};
        function onDragStart(e, customerId, customerName, callDate) {
            const c = customers.find(x => x.id === customerId);
            dragData = { customerId, customerName: c ? c.name : customerName, callDate };
            e.dataTransfer.effectAllowed = 'move';
            e.dataTransfer.setData('text/plain', String(customerId));
        }
        function onDragOver(e) { e.preventDefault(); e.currentTarget.classList.add('drag-over'); }
        function onDragLeave(e) { e.currentTarget.classList.remove('drag-over'); }
        function onDrop(e, employeeName) {
            e.preventDefault(); e.currentTarget.classList.remove('drag-over');
            document.getElementById('assign-customer-id').value = dragData.customerId;
            document.getElementById('assign-customer-name').value = dragData.customerName;
            document.getElementById('assign-employee-name').value = employeeName;
            document.getElementById('assign-employee-display').value = employeeName;
            document.getElementById('assign-call-time').value = dragData.callDate || '';
            document.getElementById('assign-goals').value = '';
            openModal('assignment-modal');
        }
        function saveAssignment(e) {
            e.preventDefault();
            assignments.push({
                id: Date.now(),
                customerId: parseInt(document.getElementById('assign-customer-id').value),
                customerName: document.getElementById('assign-customer-name').value,
                employeeName: document.getElementById('assign-employee-name').value,
                callTime: document.getElementById('assign-call-time').value,
                goals: document.getElementById('assign-goals').value
            });
            saveAssignments(); closeModal('assignment-modal'); renderAssignments(); showToast('Customer assigned!');
        }
        function removeAssignment(id) { assignments = assignments.filter(a => a.id !== id); saveAssignments(); renderAssignments(); showToast('Unassigned'); }
        function addAssignmentEmployee() {
            const name = prompt('Employee name:'); if (!name || !name.trim()) return;
            if (assignmentEmployees.includes(name.trim())) { showToast('Already exists', 'error'); return; }
            assignmentEmployees.push(name.trim()); saveAssignments(); renderAssignments(); showToast('Employee added');
        }
        function removeAssignmentEmployee(name) {
            if (!confirm(`Remove ${name}? Their assignments will also be removed.`)) return;
            assignmentEmployees = assignmentEmployees.filter(e => e !== name);
            assignments = assignments.filter(a => a.employeeName !== name);
            saveAssignments(); renderAssignments(); showToast('Employee removed');
        }

        // === CLIENT FOLDERS ===
        let folderNotes = {}; // { customerId: [{ id, text, createdAt }] }
        let currentFolderId = null;

        function loadFolderNotes() {
            const saved = localStorage.getItem('folderNotes');
            if (saved) folderNotes = JSON.parse(saved);
        }
        function saveFolderNotes() { localStorage.setItem('folderNotes', JSON.stringify(folderNotes)); syncToCloud(); }

        function renderFolders() {
            const grid = document.getElementById('folders-grid');
            if (!grid) return;
            if (customers.length === 0) {
                grid.innerHTML = '<p style="color:#888;text-align:center;padding:2rem;">No customers yet. Add one in the Customers tab!</p>';
                return;
            }
            grid.innerHTML = customers.map(c => {
                const noteCount = (folderNotes[c.id] || []).length;
                return `<div class="folder-card" onclick="openFolder(${c.id})">
                    <div class="folder-icon">üìÅ</div>
                    <div class="folder-name">${c.name}</div>
                    <div class="folder-meta">${noteCount} note${noteCount!==1?'s':''}</div>
                </div>`;
            }).join('');
        }

        function openFolder(customerId) {
            currentFolderId = customerId;
            const c = customers.find(x => x.id === customerId);
            if (!c) return;
            document.getElementById('folder-detail-name').textContent = 'üìÅ ' + c.name;
            document.getElementById('folder-detail-time').textContent = c.callDate ? new Date(c.callDate).toLocaleString() : 'Not set';
            document.getElementById('folder-detail-customer-notes').textContent = c.notes || 'None';
            document.getElementById('folder-new-note').value = '';
            renderFolderNotes();
            // Switch to folder-detail view
            document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
            document.getElementById('folder-detail').classList.add('active');
        }

        function closeFolderDetail() {
            currentFolderId = null;
            document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
            document.getElementById('folders').classList.add('active');
            renderFolders();
        }

        function renderFolderNotes() {
            const notes = (folderNotes[currentFolderId] || []).sort((a,b) => b.createdAt.localeCompare(a.createdAt));
            const list = document.getElementById('folder-notes-list');
            if (notes.length === 0) {
                list.innerHTML = '<p style="color:#666;">No internal notes yet.</p>';
                return;
            }
            list.innerHTML = notes.map(n => `<div class="note-card">
                <div style="display:flex;justify-content:space-between;align-items:center;">
                    <div class="note-time">${new Date(n.createdAt).toLocaleString()}</div>
                    <span style="cursor:pointer;color:#888;font-size:0.8rem;" onclick="deleteFolderNote(${currentFolderId},${n.id})">üóëÔ∏è</span>
                </div>
                <div class="note-text">${n.text}</div>
            </div>`).join('');
        }

        function addFolderNote() {
            const text = document.getElementById('folder-new-note').value.trim();
            if (!text) return;
            if (!folderNotes[currentFolderId]) folderNotes[currentFolderId] = [];
            folderNotes[currentFolderId].push({ id: Date.now(), text, createdAt: new Date().toISOString() });
            saveFolderNotes();
            document.getElementById('folder-new-note').value = '';
            renderFolderNotes();
            showToast('Note added');
        }

        function deleteFolderNote(customerId, noteId) {
            if (!confirm('Delete this note?')) return;
            folderNotes[customerId] = (folderNotes[customerId]||[]).filter(n => n.id !== noteId);
            saveFolderNotes(); renderFolderNotes();
            showToast('Note deleted');
        }

        window.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>
